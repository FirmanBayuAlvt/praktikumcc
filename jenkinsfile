pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'my-docker-image:latest'
        DOCKERHUB_USER = 'dockerhub-username'
        DOCKERHUB_CRED = 'dockerhub-creds'
        ANSIBLE_SERVER = 'user@ansible-server'
        K8S_SERVER = 'user@k8s-server'
    }

    stages {
        stage('Build') {
            steps {
                echo 'Building Docker image...'
                sh '''
                    docker build -t ${DOCKERHUB_USER}/${DOCKER_IMAGE} .
                '''
            }
        }
        
        stage('Test') {
            steps {
                echo 'Testing Docker image...'
                sh '''
                    docker run --rm ${DOCKERHUB_USER}/${DOCKER_IMAGE} /bin/sh -c "echo 'Image test passed!'"
                '''
            }
        }

        stage('Deploy') {
            parallel {
                stage('Push to DockerHub') {
                    steps {
                        echo 'Pushing Docker image to DockerHub...'
                        withCredentials([string(credentialsId: "${DOCKERHUB_CRED}", variable: 'DOCKERHUB_PASS')]) {
                            sh '''
                                docker login -u ${DOCKERHUB_USER} -p ${DOCKERHUB_PASS}
                                docker push ${DOCKERHUB_USER}/${DOCKER_IMAGE}
                            '''
                        }
                    }
                }
                
                stage('Deploy to Kubernetes') {
                    steps {
                        echo 'Deploying to Kubernetes...'
                        sh '''
                            scp k8s-config.yaml ${K8S_SERVER}:/home/user/k8s-config.yaml
                            ssh ${ANSIBLE_SERVER} "ansible-playbook -i /home/user/inventory /home/user/k8s-deployment.yaml"
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed, check logs for details!'
        }
    }
}
